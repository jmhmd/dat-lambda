<html>

<head>
  <title>Anonymize DICOM with Lambda</title>
  <script src="https://unpkg.com/dicom-parser@1.7.5/dist/dicomParser.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dot/1.1.2/doT.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/1.3.3/FileSaver.min.js"></script>
</head>

<body>
  <h2>Anonymize DICOM with AWS Lambda</h2>
  <p>
    This proof-of-concept takes advantage of serverless computing to perform DICOM file anonymization. Choose a DICOM file below,
    and click "Anonymize" to kick off the process. Here's what will happen:
  </p>
  <ol>
    <li>The DICOM file headers are parsed in the browser before upload, and some pertient info is displayed</li>
    <li>
      Upon clicking "Anonymize", the file is securely uploaded (via SSL/HTTPS) to an HTTP endpoint defined in Amazon API Gateway,
      which forwards the multipart/form-data binary upload to an AWS Lambda function.
    </li>
    <li>
      The Lambda function contains an instance of the RSNA DicomAnonymizerTool, which is used within CTP and MIRC to perform anonymization.
    </li>
    <li>
      Upon receiving the image data, the file is immediately anonymized returned to the browser via the encrypted SSL/HTTPS response,
      and deleted.
    </li>
  </ol>
  <p>
    Some important points:
  </p>
  <ul>
    <li>
      This is for example/testing purposes ONLY. DO NOT upload files containing Protected Health Information as defined by HIPAA.
      If you don't know what that is, this tool probably isn't for you.
    </li>
    <li>
      That said, if used in a properly managed healthcare environment with appropriate HIPAA logging and other standard security
      practices, this tool would conform to HIPAA PHI protection requirements when used with an AWS account having a signed
      BAA in place. The data is encrypted in transit via SSL/HTTPS, anonymized immediately and not stored anywhere outside
      the client machine.
    </li>
    <li>
      The <a href="https://github.com/jmhmd/dat-lambda">source code is here.</a>
    </li>
  </ul>
  <form action="https://lnrwbd1157.execute-api.us-east-2.amazonaws.com/test/upload"
        method="POST"
        enctype="multipart/form-data"
        id="file-upload-form"
        onsubmit="uploadAsFormData(event)">
    <input type="file"
           name="file"
           id="file"
           onchange="fileChange()" />
    <br><br>
    <label>
      <input type="checkbox" name="no-phi" id="no-phi" /> I attest that this file does not contain Protected Health Information.
    </label>
    <br><br>
    <button type="submit">Anonymize</button>
  </form>
  <h3>Input file details:</h3>
  <div id="input-file-data"></div>
  <h3>Output file details:</h3>
  <div id="output-file-data"></div>
  <script type="text/template"
          id="dicom-headers">
    <table>
      <tr>
        <td>Patient's Name</td>
        <td>{{=it.string('x00100010')}}</td>
      </tr>
      <tr>
        <td>Patient ID</td>
        <td>{{=it.string('x00100020')}}</td>
      </tr>
      <tr>
        <td>Study Description</td>
        <td>{{=it.string('x00081030')}}</td>
      </tr>
      <tr>
        <td>Series Description</td>
        <td>{{=it.string('x0008103e')}}</td>
      </tr>
      <tr>
        <td>Accession Number</td>
        <td>{{=it.string('x00080050')}}</td>
      </tr>
      <tr>
        <td>Study Date</td>
        <td>{{=it.string('x00080020')}}</td>
      </tr>
      <tr>
        <td>Study Time</td>
        <td>{{=it.string('x00080030')}}</td>
      </tr>
      <tr>
        <td>Modality</td>
        <td>{{=it.string('x00080060')}}</td>
      </tr>
      <tr>
        <td>Institution Name</td>
        <td>{{=it.string('x00080080')}}</td>
      </tr>
    </table>
  </script>
  <script>
    const uploadAction = document.getElementById('file-upload-form').getAttribute('action');
    let file;

    const saveByteArray = (function () {
      var a = document.createElement("a");
      document.body.appendChild(a);
      a.style = "display: none";
      return function (data, name) {
        var blob = new Blob([data], { type: "octet/stream" }),
          url = window.URL.createObjectURL(blob);
        a.href = url;
        a.download = name;
        a.click();
        window.URL.revokeObjectURL(url);
      };
    }());

    function uploadAsFormData(event) {
      event.preventDefault();
      const formData = new FormData();
      const resultElement = document.getElementById('output-file-data');
      const phiAttestation = document.getElementById('no-phi').checked;

      if (!file || !phiAttestation) { return false; }

      formData.append('file', file);

      resultElement.innerHTML = 'Request sent, loading...';

      fetch(uploadAction, {
        method: 'POST',
        body: formData,
      }).then((response) => {
        response.arrayBuffer().then((fileBuffer) => {
          const fileUint8Array = new Uint8Array(fileBuffer);
          const dataset = dicomParser.parseDicom(fileUint8Array);

          const dicomTemplate = doT.template(document.getElementById('dicom-headers').innerHTML);
          const info = dicomTemplate(dataset);
          const downloadLink = `<a href="#" id="download-output-file">Download file</a`;
          resultElement.innerHTML = info + downloadLink;
          document.getElementById('download-output-file').addEventListener('click', (ev) => {
            ev.preventDefault();
            // saveByteArray(fileBuffer, 'output-anonymized.dcm');
            const blob = new Blob([fileBuffer], { type: "octet/stream" });
            saveAs(blob, `anonymized-${file.name}`);
          })
        })
      }).catch((error) => { resultElement.innerHTML = error })
    }

    function fileChange() {
      file = document.getElementById('file').files[0];
      const reader = new FileReader();
      const resultElement = document.getElementById('input-file-data');
      reader.onload = (e) => {
        const inputFileArrayBuffer = e.target.result;
        try {
          const fileUint8Array = new Uint8Array(inputFileArrayBuffer);
          const dataset = dicomParser.parseDicom(fileUint8Array);

          const dicomTemplate = doT.template(document.getElementById('dicom-headers').innerHTML);
          resultElement.innerHTML = dicomTemplate(dataset);
        } catch (e) {
          resultElement.innerHTML = e;
        }
      }
      reader.readAsArrayBuffer(file);
    }
  </script>
</body>

</html>
